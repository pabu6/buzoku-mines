<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ÈÉ®Êóè„ÅÆÁî∑„Éû„Ç§„É≥„Çπ„Ç§„Éº„Éë„Éº</title>

<style>
:root{--cell-size:36px;}

body{
  margin:0;
  font-family:sans-serif;
  background:url("jungle.jpg") center/cover no-repeat fixed;
  color:#fff;
}

#container{
  display:flex;
  min-height:100vh;
}

/* PC */
@media(min-width:768px){
  #container{justify-content:center;align-items:center;gap:32px;}
  :root{--cell-size:48px;}
}

/* Mobile */
@media(max-width:767px){
  #container{flex-direction:column;align-items:center;}
  :root{--cell-size:min(9vw,40px);}
}

#game{
  padding:10px;
  background:rgba(0,0,0,.3);
  border-radius:6px;
  position:relative;
  transition:filter .5s;
}
#game.last-dark{filter:brightness(0.7);}

table{border-collapse:collapse;}
td{
  width:var(--cell-size);
  height:var(--cell-size);
  border:1px solid #1b3a2a;
  background:#2e6b4f;
  text-align:center;
  font-weight:bold;
  cursor:pointer;
  font-size:calc(var(--cell-size)*0.5);
}
td:hover{background:#3f8f6b;}
td.open{background:#cfd8dc;cursor:default;}

.num1{color:#1976d2;}
.num2{color:#2e7d32;}
.num3{color:#d32f2f;}
.num4{color:#7b1fa2;}
.num5{color:#5d4037;}
.num6{color:#00838f;}
.num7{color:#424242;}
.num8{color:#000;}

td.flag{background:#1b3a2a;color:#0f0;}
td.enemy{
  background:black url("tribe.jpeg") center/cover no-repeat;
  animation:pop .4s ease;
}

@keyframes pop{
  0%{transform:scale(1);}
  50%{transform:scale(1.2);}
  100%{transform:scale(1);}
}

/* SIDE */
#side{
  background:rgba(8,20,15,.7);
  padding:12px;
  text-align:center;
  border-radius:8px;
}
@media(min-width:768px){#side{width:300px;}}
@media(max-width:767px){#side{width:100%;}}

#explorer{
  width:min(260px,80vw);
  transition:.4s;
}
@media(min-width:768px){#explorer{width:320px;}}

#explorer.perfect{
  border:6px solid gold;
  border-radius:14px;
  box-shadow:0 0 30px gold;
  cursor:pointer;
}
#explorer.captured{filter:grayscale(40%) brightness(.8);}

#status{
  margin-top:8px;
  font-size:18px;
  font-weight:bold;
}
#status.clear{
  color:gold;
  text-shadow:0 0 8px gold;
}

button{
  margin-top:8px;
  padding:8px 16px;
  font-size:16px;
  background:#2e6b4f;
  border:none;
  color:white;
  cursor:pointer;
}

/* PERFECT Êã°Â§ß */
#zoomOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.85);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:9999;
}
#zoomOverlay img{
  max-width:90vw;
  max-height:90vh;
  border:8px solid gold;
  border-radius:16px;
  box-shadow:0 0 40px gold;
}

#boardMessage{
  position:absolute;
  inset:0;
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:34px;
  font-weight:bold;
  color:gold;
  background:rgba(0,0,0,.45);
}
</style>
</head>

<body>
<div id="container">
  <div id="game"></div>
  <div id="side">
    <img id="explorer" src="explorer.jpeg">
    <div id="status">Êé¢Ê§úÈñãÂßãÔºÅ</div>
    <button id="restart">RESTART</button>
    <button id="bgmToggle">BGM ON</button>
  </div>
</div>

<div id="zoomOverlay"><img id="zoomImage"></div>

<audio id="seOpen" src="open.mp3"></audio>
<audio id="seFlag" src="flag.mp3"></audio>
<audio id="seDeath" src="death.mp3"></audio>
<audio id="seClear" src="clear.mp3"></audio>
<audio id="sePerfect" src="perfect.mp3"></audio>
<audio id="bgm" src="bgm.mp3" loop></audio>
<audio id="lastBgm" src="last.mp3" loop></audio>

<script>
const ROWS=9,COLS=9,ENEMIES=10;
let board=[],opened=[],flags=[],gameOver=false;
let usedFlag=false,lastMode=false;

const game=document.getElementById("game");
const explorer=document.getElementById("explorer");
const status=document.getElementById("status");
const bgmToggle=document.getElementById("bgmToggle");
const zoomOverlay=document.getElementById("zoomOverlay");
const zoomImage=document.getElementById("zoomImage");

const bgm=document.getElementById("bgm");
const lastBgm=document.getElementById("lastBgm");
const seOpen=document.getElementById("seOpen");
const seFlag=document.getElementById("seFlag");
const seDeath=document.getElementById("seDeath");
const seClear=document.getElementById("seClear");
const sePerfect=document.getElementById("sePerfect");

function play(se){se.currentTime=0;se.play().catch(()=>{});}

document.getElementById("restart").onclick=init;

bgmToggle.onclick=()=>{
  if(bgm.paused && lastBgm.paused){bgm.play();bgmToggle.textContent="BGM OFF";}
  else{bgm.pause();lastBgm.pause();bgmToggle.textContent="BGM ON";}
};

explorer.onclick=()=>{
  if(!explorer.classList.contains("perfect"))return;
  zoomImage.src=explorer.src;
  zoomOverlay.style.display="flex";
};
zoomOverlay.onclick=()=>zoomOverlay.style.display="none";

function init(){
  board=Array.from({length:ROWS},()=>Array(COLS).fill(0));
  opened=Array.from({length:ROWS},()=>Array(COLS).fill(false));
  flags=Array.from({length:ROWS},()=>Array(COLS).fill(false));
  gameOver=false;usedFlag=false;lastMode=false;
  explorer.src="explorer.jpeg";explorer.className="";
  status.textContent="Êé¢Ê§úÈñãÂßãÔºÅ";status.className="";
  zoomOverlay.style.display="none";

  let placed=0;
  while(placed<ENEMIES){
    let r=Math.random()*ROWS|0,c=Math.random()*COLS|0;
    if(board[r][c]!=="E"){board[r][c]="E";placed++;}
  }

  for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){
    if(board[r][c]==="E")continue;
    let n=0;
    for(let dr=-1;dr<=1;dr++)for(let dc=-1;dc<=1;dc++){
      let nr=r+dr,nc=c+dc;
      if(nr>=0&&nr<ROWS&&nc>=0&&nc<COLS&&board[nr][nc]==="E")n++;
    }
    board[r][c]=n;
  }
  draw();
}

function draw(){
  game.innerHTML="";
  const table=document.createElement("table");

  for(let r=0;r<ROWS;r++){
    const tr=document.createElement("tr");
    for(let c=0;c<COLS;c++){
      const td=document.createElement("td");

      if(opened[r][c]){
        td.classList.add("open");
        if(board[r][c]==="E")td.classList.add("enemy");
        else if(board[r][c]>0){td.textContent=board[r][c];td.classList.add("num"+board[r][c]);}
      }else if(flags[r][c]){
        td.classList.add("flag");
        td.textContent="üö©";
      }

      // ÈÄöÂ∏∏„Çø„ÉÉ„Éó
      td.onclick=()=>{if(!gameOver&&!flags[r][c]){openCell(r,c);draw();}};

      // PCÂè≥„ÇØ„É™„ÉÉ„ÇØ
      td.oncontextmenu=e=>{
        e.preventDefault();
        toggleFlag(r,c);
      };

      // „Çπ„Éû„ÉõÈï∑Êäº„Åó
      let pressTimer;
      td.ontouchstart=e=>{
        pressTimer=setTimeout(()=>toggleFlag(r,c),500);
      };
      td.ontouchend=()=>clearTimeout(pressTimer);
      td.ontouchmove=()=>clearTimeout(pressTimer);

      tr.appendChild(td);
    }
    table.appendChild(tr);
  }
  game.appendChild(table);
}

function toggleFlag(r,c){
  if(opened[r][c]||gameOver)return;
  flags[r][c]=!flags[r][c];
  usedFlag=true;
  play(seFlag);
  draw();
}

function openCell(r,c){
  if(opened[r][c])return;
  opened[r][c]=true;
  play(seOpen);

  if(board[r][c]==="E"){
    gameOver=true;
    play(seDeath);
    explorer.src="explorer_captured.jpeg";
    explorer.classList.add("captured");
    status.textContent="Êçï„Åæ„Å£„Å¶„Åó„Åæ„Å£„Åü‚Ä¶";
    for(let i=0;i<ROWS;i++)for(let j=0;j<COLS;j++)
      if(board[i][j]==="E")opened[i][j]=true;
    return;
  }

  if(board[r][c]===0)
    for(let dr=-1;dr<=1;dr++)for(let dc=-1;dc<=1;dc++){
      let nr=r+dr,nc=c+dc;
      if(nr>=0&&nr<ROWS&&nc>=0&&nc<COLS)openCell(nr,nc);
    }

  checkClear();
}

function checkClear(){
  let safe=ROWS*COLS-ENEMIES,count=0;
  for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++)
    if(opened[r][c]&&board[r][c]!=="E")count++;

  if(count===safe){
    gameOver=true;
    status.classList.add("clear");

    if(!usedFlag){
      play(sePerfect);
      status.textContent="PERFECT CLEAR!!";
      explorer.src="explorer_perfect.jpeg";
      explorer.classList.add("perfect");
    }else{
      play(seClear);
      status.textContent="CONGRATULATIONS!!";
      explorer.src="explorer_clear.jpeg";
    }
  }
}

init();
</script>
</body>
</html>
